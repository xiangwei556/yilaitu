# 支付系统技术方案

## 一、系统概述

### 1.1 业务需求
- 支持微信支付和支付宝支付
- 支持会员包月费用购买
- 支持积分包购买
- 用户扫码支付后才生成订单（预订单机制）
- 支付成功后自动开通会员/充值积分

### 1.2 技术架构
- **后端框架**: FastAPI
- **数据库**: MySQL (订单数据) + Redis (支付状态缓存)
- **支付渠道**: 微信支付、支付宝支付
- **通知机制**: 支付回调 + WebSocket实时通知

## 二、数据库设计

### 2.1 订单表扩展 (orders)
在现有Order模型基础上，需要添加以下字段：
```sql
ALTER TABLE orders ADD COLUMN payment_no VARCHAR(100) COMMENT '支付平台订单号';
ALTER TABLE orders ADD COLUMN qr_code_url TEXT COMMENT '支付二维码URL';
ALTER TABLE orders ADD COLUMN qr_code_expire_at DATETIME COMMENT '二维码过期时间';
ALTER TABLE orders ADD COLUMN callback_data TEXT COMMENT '支付回调原始数据(JSON)';
ALTER TABLE orders ADD COLUMN notify_url VARCHAR(255) COMMENT '支付回调通知地址';
ALTER TABLE orders ADD COLUMN expire_at DATETIME COMMENT '订单过期时间';
ALTER TABLE orders ADD COLUMN retry_count INT DEFAULT 0 COMMENT '支付状态查询重试次数';
ALTER TABLE orders ADD INDEX idx_payment_no (payment_no);
ALTER TABLE orders ADD INDEX idx_status_created (status, created_at);
```

### 2.2 支付记录表 (payment_records)
用于记录所有支付相关操作，便于对账和问题排查：
```sql
CREATE TABLE payment_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL COMMENT '订单号',
    payment_no VARCHAR(100) COMMENT '支付平台订单号',
    payment_method VARCHAR(20) NOT NULL COMMENT '支付方式: wechat, alipay',
    action_type VARCHAR(50) NOT NULL COMMENT '操作类型: create, callback, query, refund',
    amount DECIMAL(10, 2) NOT NULL COMMENT '金额',
    status VARCHAR(20) NOT NULL COMMENT '状态: success, failed, pending',
    request_data TEXT COMMENT '请求数据(JSON)',
    response_data TEXT COMMENT '响应数据(JSON)',
    error_message TEXT COMMENT '错误信息',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_no (order_no),
    INDEX idx_payment_no (payment_no),
    INDEX idx_created_at (created_at)
) COMMENT='支付记录表';
```

## 三、支付流程设计

### 3.1 支付流程时序图
```
用户 -> 前端: 选择商品(会员/积分包)
前端 -> 后端: POST /api/v1/payment/create-order
后端 -> 后端: 创建预订单(status=pending)
后端 -> 支付平台: 调用统一下单API
支付平台 -> 后端: 返回支付二维码
后端 -> 前端: 返回订单号和二维码
前端 -> 用户: 显示二维码
用户 -> 支付平台: 扫码支付
支付平台 -> 后端: 支付回调(异步)
后端 -> 后端: 验证签名、更新订单状态
后端 -> 后端: 执行业务逻辑(开通会员/充值积分)
后端 -> 前端: WebSocket通知支付成功
前端 -> 用户: 显示支付成功
```

### 3.2 订单状态流转
```
pending (待支付)
  ↓ (用户扫码支付)
paid (已支付) -> 执行业务逻辑
  ↓ (支付失败/超时)
cancelled (已取消)
  ↓ (退款)
refunded (已退款)
```

## 四、核心模块设计

### 4.1 支付服务层 (PaymentService)

#### 4.1.1 微信支付服务 (WeChatPayService)
**功能**:
- 统一下单 (native支付)
- 查询订单状态
- 处理支付回调
- 验证签名

**关键方法**:
```python
class WeChatPayService:
    async def create_order(order_no, amount, description) -> dict
    async def query_order(payment_no) -> dict
    async def verify_callback(data, signature) -> bool
    async def process_callback(data) -> dict
```

#### 4.1.2 支付宝支付服务 (AlipayService)
**功能**:
- 统一下单 (当面付/扫码支付)
- 查询订单状态
- 处理支付回调
- 验证签名

**关键方法**:
```python
class AlipayService:
    async def create_order(order_no, amount, subject) -> dict
    async def query_order(payment_no) -> dict
    async def verify_callback(params) -> bool
    async def process_callback(params) -> dict
```

### 4.2 订单服务层 (OrderService)

**功能**:
- 创建预订单
- 更新订单状态
- 订单过期处理
- 订单查询

**关键方法**:
```python
class OrderService:
    def create_pre_order(user_id, product_type, product_id, payment_method) -> Order
    def update_order_status(order_no, status, payment_data) -> Order
    def cancel_expired_orders() -> int
    def get_order_by_no(order_no) -> Order
```

### 4.3 业务处理层 (BusinessService)

**功能**:
- 支付成功后的业务处理
- 开通会员
- 充值积分

**关键方法**:
```python
class BusinessService:
    def process_membership_order(order: Order) -> bool
    def process_points_order(order: Order) -> bool
    def process_membership_upgrade(order: Order) -> bool
```

## 五、API接口设计

### 5.1 创建支付订单
```
POST /api/v1/payment/create-order
Request:
{
    "product_type": "membership" | "points",
    "product_id": 1,
    "payment_method": "wechat" | "alipay",
    "is_upgrade": false  // 仅会员订单有效
}
Response:
{
    "code": 200,
    "data": {
        "order_no": "ORD202501011200001",
        "amount": 99.00,
        "qr_code_url": "weixin://wxpay/bizpayurl?pr=xxx",
        "qr_code_expire_at": "2025-01-01T12:15:00",
        "expire_at": "2025-01-01T12:30:00"
    }
}
```

### 5.2 查询订单状态
```
GET /api/v1/payment/order-status?order_no=ORD202501011200001
Response:
{
    "code": 200,
    "data": {
        "order_no": "ORD202501011200001",
        "status": "paid",
        "amount": 99.00,
        "payment_time": "2025-01-01T12:05:00"
    }
}
```

### 5.3 支付回调接口
```
POST /api/v1/payment/wechat/callback  # 微信回调
POST /api/v1/payment/alipay/callback  # 支付宝回调
```

### 5.4 取消订单
```
POST /api/v1/payment/cancel-order
Request:
{
    "order_no": "ORD202501011200001"
}
```

## 六、安全设计

### 6.1 签名验证
- **微信支付**: 使用微信提供的签名算法验证回调数据
- **支付宝**: 使用RSA2签名验证回调数据
- 所有回调必须验证签名，未通过验证的请求直接拒绝

### 6.2 幂等性保证
- 订单号唯一性约束
- 支付回调处理使用数据库事务 + 乐观锁
- 重复回调只处理一次

### 6.3 防重放攻击
- 记录已处理的支付回调ID
- 使用Redis记录处理状态，防止重复处理
- 设置合理的订单过期时间

### 6.4 金额校验
- 支付回调中的金额必须与订单金额一致
- 不一致时记录异常并拒绝处理

## 七、异常处理

### 7.1 支付超时处理
- 订单创建后30分钟未支付自动取消
- 使用定时任务扫描过期订单
- 前端轮询订单状态，超时后提示用户

### 7.2 支付失败处理
- 记录失败原因到payment_records表
- 支持用户重新发起支付（创建新订单）
- 发送失败通知给用户

### 7.3 回调失败处理
- 支付平台会重试回调（最多5次）
- 如果回调失败，使用定时任务主动查询订单状态
- 记录所有回调日志便于排查

### 7.4 业务处理失败
- 如果支付成功但业务处理失败，记录异常
- 使用补偿机制重试业务处理
- 人工介入处理异常订单

## 八、监控与日志

### 8.1 关键指标监控
- 支付成功率
- 支付平均耗时
- 回调处理延迟
- 订单取消率
- 异常订单数量

### 8.2 日志记录
- 所有支付相关操作记录到payment_records表
- 关键操作记录详细日志（请求/响应数据）
- 异常情况记录错误堆栈

### 8.3 告警机制
- 支付成功率低于阈值告警
- 回调处理失败率过高告警
- 异常订单数量异常告警

## 九、配置管理

### 9.1 支付配置 (config.py)
```python
# 微信支付配置
WECHAT_PAY_APP_ID: str
WECHAT_PAY_MCH_ID: str
WECHAT_PAY_API_KEY: str
WECHAT_PAY_CERT_PATH: str  # 证书路径
WECHAT_PAY_NOTIFY_URL: str

# 支付宝配置
ALIPAY_APP_ID: str
ALIPAY_PRIVATE_KEY: str
ALIPAY_PUBLIC_KEY: str
ALIPAY_NOTIFY_URL: str
ALIPAY_RETURN_URL: str

# 订单配置
ORDER_EXPIRE_MINUTES: int = 30  # 订单过期时间(分钟)
QR_CODE_EXPIRE_MINUTES: int = 15  # 二维码过期时间(分钟)
```

## 十、部署注意事项

### 10.1 证书管理
- 微信支付证书需要安全存储
- 支付宝公钥需要正确配置
- 生产环境使用环境变量管理敏感信息

### 10.2 回调地址配置
- 微信支付回调地址需要在微信商户平台配置
- 支付宝回调地址需要在支付宝开放平台配置
- 回调地址必须使用HTTPS（生产环境）

### 10.3 定时任务
- 订单过期检查任务（每分钟执行）
- 支付状态查询任务（每5分钟执行，查询pending状态的订单）
- 异常订单处理任务（每小时执行）

## 十一、测试方案

### 11.1 单元测试
- 支付服务签名验证测试
- 订单服务业务逻辑测试
- 回调处理测试

### 11.2 集成测试
- 完整支付流程测试
- 支付回调测试
- 异常场景测试

### 11.3 沙箱环境测试
- 使用微信支付和支付宝的沙箱环境
- 测试各种支付场景（成功、失败、超时）

## 十二、实施步骤

### 阶段一：基础架构搭建
1. 扩展订单表结构
2. 创建支付记录表
3. 配置支付平台参数
4. 实现支付服务基础框架

### 阶段二：微信支付对接
1. 实现微信支付统一下单
2. 实现微信支付回调处理
3. 实现微信支付订单查询
4. 测试微信支付流程

### 阶段三：支付宝支付对接
1. 实现支付宝统一下单
2. 实现支付宝回调处理
3. 实现支付宝订单查询
4. 测试支付宝支付流程

### 阶段四：业务逻辑集成
1. 实现会员开通逻辑
2. 实现积分充值逻辑
3. 实现会员升级逻辑
4. 集成WebSocket通知

### 阶段五：异常处理与优化
1. 实现订单过期处理
2. 实现支付状态轮询
3. 实现异常订单补偿机制
4. 性能优化与监控

### 阶段六：测试与上线
1. 完整功能测试
2. 压力测试
3. 安全测试
4. 生产环境部署

## 十三、技术选型

### 13.1 Python支付SDK
- **微信支付**: `wechatpay-python` (官方SDK) 或 `wechatpayv3`
- **支付宝**: `alipay-sdk-python` (官方SDK)

### 13.2 二维码生成
- 前端使用 `qrcode` 库生成二维码（已有）
- 后端返回支付URL，前端生成二维码

### 13.3 定时任务
- 使用 `APScheduler` 或 `Celery` 实现定时任务
- 或使用FastAPI的BackgroundTasks

## 十四、风险控制

### 14.1 资金安全
- 所有金额计算使用Decimal类型，避免浮点数误差
- 支付回调必须验证金额一致性
- 重要操作记录审计日志

### 14.2 数据一致性
- 使用数据库事务保证数据一致性
- 支付回调处理使用乐观锁防止并发问题
- 业务处理失败时支持回滚

### 14.3 系统可用性
- 支付回调接口需要高可用
- 支持支付平台回调重试
- 实现降级方案（支付失败时不影响其他功能）
