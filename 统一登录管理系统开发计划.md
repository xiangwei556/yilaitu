# 统一登录管理系统开发计划 (v2.0)

## 1. 项目概述

### 1.1 背景
为支撑公司旗下 Web、H5、iOS/Android App、微信小程序等多端产品的用户体系，构建一套**安全、可扩展、合规**的统一登录管理系统。系统需支持手机号注册/登录、微信授权登录，兼容 OAuth 2.0 协议，满足第三方应用接入及内部服务鉴权需求，同时符合《个人信息保护法》《网络安全法》合规要求。

### 1.2 目标
- **统一账号体系**：支持多凭证绑定（手机号、微信），多端登录态互通。
- **全场景登录**：覆盖验证码登录、密码登录、微信扫码/SDK登录。
- **标准授权**：提供标准 OAuth 2.0 授权能力，支持第三方接入。
- **安全风控**：Token 生命周期管理、异常登录拦截、操作审计。
- **高可用**：支持多端并发，容灾备份，满足业务峰值需求。

### 1.3 范围
- **包含**：注册/登录/登出、账号信息管理、多账号关联、微信登录对接、OAuth 2.0 服务、Token 管理、风控规则、管理后台。
- **不包含**：支付认证、第三方登录（支付宝/QQ等预留接口）、复杂用户画像。

### 1.4 代码仓库规范
所有后端代码生成在 `backend/passport` 目录下。

## 2. 技术栈与架构

### 2.1 技术栈
- **后端框架**: FastAPI 0.104+
- **数据库**: MySQL 8.0 (SQLAlchemy 2.0 ORM)
- **缓存**: Redis 7.0 (Cluster模式)
- **认证/授权**: Authlib 1.3+, Python-Jose, Passlib (BCrypt)
- **日志/搜索**: Elasticsearch + Logstash + Kibana (ELK)
- **任务队列**: Celery + Redis (用于发送短信、邮件、异步日志)
- **配置管理**: Pydantic-Settings

### 2.2 系统架构
采用微服务架构思想，核心模块包括：
1.  **账号服务 (Account Service)**: 用户注册、信息管理、凭证绑定。
2.  **认证服务 (Auth Service)**: 登录认证、验证码处理、微信接口对接。
3.  **授权服务 (OAuth Service)**: OAuth 2.0 协议实现、应用管理。
4.  **网关服务 (Gateway)**: 统一鉴权、Token 校验、限流。
5.  **风控服务 (Risk Service)**: 规则引擎、黑名单管理、异常检测。
6.  **管理后台 (Admin API)**: 运营与运维管理接口。

## 3. 数据库设计 (核心模型)

### 3.1 用户表 (users)
增加状态字段定义和敏感字段加密标识。
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE, -- 自动生成或用户设置
    nickname VARCHAR(50),
    avatar VARCHAR(255),
    gender INT DEFAULT 0, -- 0:未知, 1:男, 2:女
    hashed_password VARCHAR(255), -- BCrypt加密
    status INT DEFAULT 1, -- 1:启用, 0:禁用, -1:注销中
    cancel_at DATETIME, -- 注销申请时间 (7天冷静期)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3.2 用户凭证表 (user_credentials)
支持多凭证，敏感信息如手机号需加密存储 (AES-256)。
```sql
CREATE TABLE user_credentials (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    identifier VARCHAR(255) NOT NULL, -- 手机号(加密)、OpenID、UnionID
    credential_type VARCHAR(20) NOT NULL, -- phone, wechat_openid, wechat_unionid
    credential_info TEXT, -- 额外信息 (JSON)
    verified BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_identifier_type (identifier, credential_type),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 3.3 登录设备与Token (login_sessions)
用于管理多端登录和Token黑名单。
```sql
CREATE TABLE login_sessions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    device_id VARCHAR(100), -- 设备指纹
    device_type VARCHAR(20), -- web, app, h5, miniprogram
    access_token_jti VARCHAR(64), -- JWT ID
    refresh_token VARCHAR(128),
    expires_at DATETIME,
    is_active BOOLEAN DEFAULT TRUE,
    last_ip VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.4 操作日志 (operation_logs)
```sql
CREATE TABLE operation_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT,
    event_type VARCHAR(50), -- register, login, logout, bind...
    status VARCHAR(20), -- success, fail
    ip VARCHAR(50),
    device_fingerprint VARCHAR(100),
    client_type VARCHAR(20),
    detail TEXT, -- 失败原因等
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 功能模块详细设计

### 4.1 基础账号体系
- **手机号注册**:
    - 校验: 格式(11位) + 号段 + 验证码。
    - 风控: 同IP/手机号 1分钟1次。
    - 模式: 免密(自动创建) / 密码(设置≥8位复杂密码)。
- **微信授权注册**:
    - 获取 OpenID/UnionID。
    - 强制绑定手机号 (复用手机号验证逻辑)。
    - 非静默授权同步昵称头像。
- **账号状态管理**:
    - **注销**: 标记状态为 -1，记录 `cancel_at`。7天内登录可撤销，7天后定时任务执行数据脱敏。

### 4.2 登录认证体系
- **登录方式**:
    - **手机+验证码**: 核心方式。
    - **手机+密码**: 失败3次触发图形验证码。
    - **微信扫码 (Web)**: WebSocket 推送登录状态。
    - **微信SDK (App/小程序)**: Code 换取 OpenID 登录。
- **OAuth 2.0**:
    - Modes: Authorization Code (Web/小程序), Client Credentials (服务间), Password (内部App).
    - Scopes: `user:basic` (默认), `user:profile` (需审核).
- **多端管理**:
    - Token 按端隔离 (Web/App/H5/MiniProgram)。
    - 支持“单设备登出”和“全设备登出”。
    - 异地登录提醒 (基于IP库)。

### 4.3 Token 管理
- **Access Token**: JWT格式，有效期2小时。包含 user_id, scope, device_id, jti。
- **Refresh Token**: 随机字符串32位，有效期7天。用于滚动刷新。
- **验证机制**:
    - 网关层拦截。
    - 校验签名、过期时间。
    - 校验 Redis 黑名单 (Logout/PasswordChange/Disable 时加入黑名单)。
- **失效策略**:
    - 修改密码/解绑手机 -> 失效所有 Token。
    - 注销/禁用 -> 拒绝所有请求。

### 4.4 风控与日志
- **风控规则 (Redis实现)**:
    - 登录失败: 单账号 >5次/日 -> 锁定1小时。
    - 注册限制: 同设备 >3次/日。
    - 验证码: 同手机号 >3次/小时。
    - 设备指纹: 单设备绑定 >5个账号 -> 人工审核/告警。
- **日志存储**:
    - 热数据 (90天): MySQL。
    - 冷数据 (1年+): Elasticsearch。

## 5. 开发阶段与计划

### 5.1 阶段一：基础架构与核心模型 (1周)
- [ ] 搭建 FastAPI 项目骨架，配置 Pydantic-Settings。
- [ ] 集成 MySQL (SQLAlchemy) 和 Redis。
- [ ] 实现统一响应结构与错误处理 (Global Exception Handler)。
- [ ] 设计并迁移数据库表 (Users, Credentials, Applications)。
- [ ] 集成日志系统 (Loguru + ELK pipeline)。

### 5.2 阶段二：账号与认证服务 (2周)
- [ ] 实现短信服务接口 (对接Mock或实际服务商，含限流)。
- [ ] 开发注册接口 (手机号免密/密码模式)。
- [ ] 开发登录接口 (手机号+验证码/密码)。
- [ ] 集成图形验证码 (Captcha)。
- [ ] 开发微信服务模块 (OAuth2 URL生成, Code换Token, UserInfo获取)。
- [ ] 实现微信扫码登录 (含WebSocket) 和 SDK登录后端接口。

### 5.3 阶段三：Token管理与网关鉴权 (1周)
- [ ] 实现 JWT Access Token 生成与校验。
- [ ] 实现 Refresh Token 生成与滚动刷新逻辑。
- [ ] 开发 Token 黑名单机制 (Redis)。
- [ ] 实现多端登录状态管理 API (登出、踢下线)。
- [ ] 封装鉴权依赖 (FastAPI Dependency) 供其他服务调用。

### 5.4 阶段四：OAuth 2.0 与 开放平台 (2周)
- [ ] 基于 Authlib 实现 OAuth 2.0 Authorization Server。
- [ ] 实现 Grant Types: Code, Credentials, Password.
- [ ] 开发应用管理接口 (注册应用, Reset Secret, Redirect URI配置)。
- [ ] 实现 Scope 权限控制逻辑。

### 5.5 阶段五：风控、日志与管理后台 (1.5周)
- [ ] 实现风控中间件 (IP拦截, 频率限制)。
- [ ] 开发风控规则引擎 (基于Redis计数器)。
- [ ] 完善操作日志记录 (AOP/Middleware方式)。
- [ ] 开发管理后台 API:
    - 用户管理 (查/禁/解绑/重置密码)。
    - 应用审核。
    - 风险监控看板数据接口。
    - 日志查询接口。

### 5.6 阶段六：安全加固与测试 (1.5周)
- [ ] 敏感数据加密存储 (AES-256) 实现。
- [ ] 编写单元测试 (Pytest, Cover > 80%)。
- [ ] 压力测试 (Locust, 目标 1000 QPS)。
- [ ] 部署脚本与文档编写 (Docker/K8s)。

## 6. 非功能性指标验收
- **性能**: 登录接口 P99 < 500ms。
- **安全**: 通过 SQL 注入、XSS、重放攻击扫描。
- **合规**: 验证“注销冷静期”和“数据导出”功能。

## 7. 关键 API 概览
| 接口 | 方法 | 描述 | 权限 |
| :--- | :--- | :--- | :--- |
| `/api/v1/auth/sms/send` | POST | 发送短信验证码 | 匿名 |
| `/api/v1/auth/register/phone` | POST | 手机号注册 | 匿名 |
| `/api/v1/auth/login/phone` | POST | 手机号登录 | 匿名 |
| `/api/v1/auth/login/wechat/scan` | GET | 获取微信扫码URL | 匿名 |
| `/api/v1/oauth/authorize` | GET | OAuth2 授权页 | 登录用户 |
| `/api/v1/oauth/token` | POST | 获取 Access Token | Basic Auth |
| `/api/v1/user/profile` | GET | 获取个人信息 | Bearer Token |
| `/api/v1/admin/users/{id}/status` | PUT | 封禁/解封用户 | 管理员 |

## 8. 管理后台页面规划 (Admin Panel)

本章节列出后台管理系统所需的**前端页面清单**及其核心功能。

### 8.1 基础模块
1.  **管理员登录页 (Login)**
    - 功能: 账号密码登录，支持图形验证码。
2.  **工作台/仪表盘 (Dashboard)**
    - **核心指标卡片**: 总用户数、今日新增注册、今日活跃用户 (DAU)、今日异常拦截数。
    - **趋势图表**: 近7日注册/登录趋势图 (折线图)。
    - **快捷入口**: 待审核应用、高风险待处理、用户查询。

### 8.2 用户中心 (User Center)
3.  **用户列表页 (User List)**
    - **筛选**: 用户ID、手机号(模糊)、微信OpenID、账号状态(正常/禁用/注销中)。
    - **列表项**: ID、头像/昵称、手机号(脱敏)、注册时间、最后登录时间、状态。
    - **操作**: 查看详情、快速禁用/启用。
4.  **用户详情页 (User Profile)**
    - **基础信息**: 展示用户画像，支持“重置密码(发送短信)”、“强制注销”。
    - **绑定凭证**: 展示手机号、微信绑定情况，支持“解绑”操作 (需二次确认)。
    - **登录设备**: 列表展示当前活跃设备 (Token未过期)，支持“强制下线”。
    - **操作日志**: 该用户的历史操作记录时间轴。

### 8.3 开放平台管理 (Open Platform)
5.  **应用列表页 (App List)**
    - **筛选**: Client ID、应用名称、审核状态。
    - **操作**: 查看详情、禁用应用。
6.  **应用详情/审核页 (App Detail)**
    - **信息展示**: 应用图标、名称、简介、回调域名 (Redirect URIs)。
    - **审核操作**: 通过/驳回 (需填写驳回原因)。
    - **管理操作**: 重置 Client Secret、配置 Scope 权限、修改回调白名单。

### 8.4 安全与风控 (Security & Risk)
7.  **风控规则配置页 (Risk Rules)**
    - **表单配置**:
        - 登录失败锁定阈值 (默认5次)。
        - 验证码发送频率限制。
        - 注册频率限制。
    - **操作**: 保存即时生效 (更新Redis配置)。
8.  **黑名单管理页 (Blacklist)**
    - **Tab切换**: IP黑名单 / 账号黑名单。
    - **操作**: 手动添加黑名单 (支持设置过期时间)、移除黑名单。
9.  **风控拦截记录页 (Risk Logs)**
    - **列表**: 展示被风控规则拦截的请求记录 (时间、IP、用户、触发规则)。

### 8.5 系统运维 (System & Ops)
10. **操作日志审计页 (Audit Logs)**
    - **筛选**: 时间范围、操作人(User ID/Admin ID)、事件类型、IP地址。
    - **功能**: 列表展示，支持导出 CSV/Excel。
11. **登录策略配置页 (Auth Policy)**
    - **配置**: Token 有效期设置、密码复杂度正则、验证码位数等全局参数。
12. **管理员账号管理页 (Admin Users)**
    - **功能**: 添加/删除管理员，分配角色 (超级管理员/普通运营)。
