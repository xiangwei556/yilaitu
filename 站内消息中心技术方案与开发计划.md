# In-Site Message Center Development Plan (Final)

## 1. Backend Implementation (FastAPI + WebSocket + Redis)

### 1.1 Database & Models
- **Table Creation**:
    - `messages`: Core message table (id, sender_id, receiver_id, type, title, content, status, priority, etc.).
    - `unread_message_counts`: Performance optimization table for caching unread counts per user/type.
- **ORM Models**: Create `backend/notification/models/message.py` with SQLAlchemy models.
- **Pydantic Schemas**: Create `backend/notification/schemas/message.py` for API validation.

### 1.2 WebSocket & Real-time Service
- **WebSocket Manager**:
    - Implement a connection manager using `aioredis` (or standard `redis` async) to handle user connections.
    - Support Pub/Sub mechanism: Backend publishes to Redis channel -> WebSocket consumes and pushes to frontend.
- **Notification Service**:
    - `NotificationService.send()`: Unified entry point for sending messages.
    - Handles logic: Write to DB -> Update Unread Count -> Publish to Redis.

### 1.3 REST APIs
- **User Endpoints (`/api/v1/message/my`)**:
    - List messages (pagination, filter by type).
    - Get details (auto-mark read).
    - Mark all read.
    - Get unread counts.
- **System/Admin Endpoints (`/api/v1/message/admin`)**:
    - Send system broadcast.
    - Send specific user message.

## 2. Frontend Implementation (React)

### 2.1 WebSocket Integration
- **Global Manager**: Create `src/services/WebSocketService.ts` for singleton connection management.
- **Connection Logic**: Auto-connect on login, heartbeat, auto-reconnect.
- **Global Listener**: In `MainLayout`, listen for new messages to trigger toast notifications and update the "bell" icon count.

### 2.2 UI Components
- **Message Center Modal/Page** (Matches User's Figure 1):
    - **MessageList**: Tabbed view (All/Unread), supports pagination/infinite scroll.
    - **MessageItem**: Displays title, time, summary, read status.
    - **Bulk Actions**: "Mark all as read".
- **Message Detail Modal** (Matches User's Figure 2):
    - Displays full content, images, attachments.
    - "Download" or "Go to Detail" actions.

### 2.3 Admin Interface
- **Message Management**:
    - List system messages.
    - **Send Message Form**: Rich text editor for content, target user selection (All/Specific), type selection.

## 3. Integration & Testing
- **Event Binding**: Bind existing system events (e.g., "Image Generation Complete") to trigger `NotificationService.send()`.
- **Performance Test**: Verify WebSocket connection stability and message delivery speed.

## 4. Execution Steps
1.  **Backend**: Models & Migrations -> WebSocket Manager -> API Implementation.
2.  **Frontend**: WebSocket Service -> Global Notification UI -> Message Center Page -> Admin Send Page.
3.  **Integration**: Connect backend events to frontend notifications.
