# SaaS月度会员订阅状态机管理技术架构方案

## 一、系统概述

### 1.1 业务背景

本系统是一个SaaS月度会员订阅系统，支持以下用户类型：
- **普通用户**：未订阅任何会员套餐
- **普通会员**：基础会员权益，按月订阅
- **专业会员**：进阶会员权益，按月订阅
- **企业会员**：高级会员权益，按月订阅

### 1.2 核心业务需求

1. **会员购买**：用户可购买月度会员套餐，支付成功后获得会员权益和赠送积分
2. **自动续费**：支持微信/支付宝自动续费签约，到期自动扣款续费
3. **会员升级**：立即生效，时间累加，积分累加，需创建回退任务
4. **会员降级**：下月生效，当前周期保持原权益
5. **积分包购买**：独立购买积分包，支持自动续费

### 1.3 系统定位与职责划分

```
┌─────────────────────────────────────────────────────────────────┐
│                         业务层                                   │
├─────────────────────────────┬───────────────────────────────────┤
│         订单系统            │           订阅系统                 │
│  ┌───────────────────────┐  │  ┌─────────────────────────────┐  │
│  │ - 下单                │  │  │ - 订阅任务管理              │  │
│  │ - 支付                │  │  │ - 履约执行                  │  │
│  │ - 对账                │  │  │ - 状态机流转                │  │
│  │ - 退款                │  │  │ - 自动续费调度              │  │
│  └───────────────────────┘  │  └─────────────────────────────┘  │
├─────────────────────────────┴───────────────────────────────────┤
│                       支付网关层                                 │
│  ┌─────────────────────┐    ┌─────────────────────┐            │
│  │    微信支付          │    │    支付宝            │            │
│  │  - 委托代扣签约      │    │  - 周期扣款签约      │            │
│  │  - 预扣费通知        │    │  - 代扣通知          │            │
│  │  - 申请扣款          │    │  - 申请扣款          │            │
│  └─────────────────────┘    └─────────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

**订单系统职责**：
- 创建订单、管理订单生命周期
- 调用支付网关完成支付
- 处理支付回调、更新订单状态
- 订单对账、退款处理

**订阅系统职责**：
- 管理订阅任务的创建、状态流转
- 执行履约动作（发放积分、变更权益）
- 调度自动续费任务
- 处理升级/降级的特殊订阅逻辑

---

## 二、数据模型设计

### 2.1 订阅表（subscription）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID |
| order_no | VARCHAR(50) | 关联订单号 |
| status | VARCHAR(20) | 状态：pending/active/cancelled/completed/paused |
| execution_type | VARCHAR(20) | 执行类型：immediate/future |
| fulfillment_type | VARCHAR(20) | 履约类型：membership/points/membership_only |
| membership_level | INT | 会员等级：1-普通/2-专业/3-企业（可为空） |
| points_amount | INT | 积分数量（可为空） |
| auto_renew | BOOLEAN | 是否自动续费 |
| effective_time | DATETIME | 生效时间 |
| expire_time | DATETIME | 到期时间 |
| subscription_period | INT | 订阅周期（天数） |
| parent_subscription_id | BIGINT | 父订阅ID（升级场景的回退订阅关联） |
| contract_id | VARCHAR(100) | 微信/支付宝签约协议ID |
| payment_method | VARCHAR(20) | 支付方式：wechat/alipay |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**状态枚举说明**：
```
pending    - 待生效：订阅已创建，等待执行履约或等待未来时间点生效
active     - 生效中：订阅正在生效，用户享有对应权益
cancelled  - 已取消：用户主动取消或系统取消
completed  - 已完成：订阅周期结束，正常完成
paused     - 已暂停：因升级等原因暂停，后续可能恢复
```

**执行类型说明**：
```
immediate  - 立即执行：支付完成后立即执行履约
future     - 未来执行：等待当前订阅到期后再执行履约
```

**履约类型说明**：
```
membership       - 会员套餐：包含积分发放 + 权益变更
points           - 积分包：仅发放积分
membership_only  - 仅权益：仅变更权益等级（升级回退场景）
```

### 2.2 自动续费签约表（auto_renew_contract）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID |
| contract_id | VARCHAR(100) | 支付平台签约协议ID |
| contract_code | VARCHAR(128) | 商户侧签约协议号 |
| payment_method | VARCHAR(20) | 支付方式：wechat/alipay |
| plan_id | VARCHAR(50) | 协议模板ID |
| status | VARCHAR(20) | 状态：signing/active/terminated |
| product_type | VARCHAR(20) | 签约产品类型：membership/points |
| product_id | BIGINT | 签约产品ID |
| signed_time | DATETIME | 签约时间 |
| terminated_time | DATETIME | 解约时间 |
| termination_mode | VARCHAR(20) | 解约方式：user/merchant/platform |
| openid | VARCHAR(128) | 用户openid |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 2.3 订阅履约日志表（subscription_fulfillment_log）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| subscription_id | BIGINT | 订阅ID |
| action_type | VARCHAR(50) | 动作类型：grant_points/change_level/restore_level |
| before_value | VARCHAR(100) | 变更前值 |
| after_value | VARCHAR(100) | 变更后值 |
| status | VARCHAR(20) | 执行状态：success/failed |
| error_message | TEXT | 错误信息 |
| created_at | DATETIME | 创建时间 |

---

## 三、订阅状态机设计

### 3.1 状态流转图

```
                    ┌─────────────────────────────────────────┐
                    │                                         │
                    ▼                                         │
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────────┐    │
│ pending │───▶│ active  │───▶│completed│    │ cancelled│    │
│ (待生效) │    │ (生效中) │    │ (已完成) │    │ (已取消)  │    │
└─────────┘    └─────────┘    └─────────┘    └──────────┘    │
     │              │                              ▲          │
     │              │         ┌─────────┐          │          │
     │              └────────▶│ paused  │──────────┘          │
     │                        │ (已暂停) │────────────────────┘
     │                        └─────────┘
     │                              ▲
     └──────────────────────────────┘
```

### 3.2 状态转换规则

| 当前状态 | 目标状态 | 触发条件 | 说明 |
|----------|----------|----------|------|
| pending | active | 立即执行履约完成 | 首次购买、升级场景 |
| pending | cancelled | 用户取消/系统取消 | 未生效前取消 |
| pending | paused | 被新订阅替代 | 升级场景暂停原订阅 |
| active | completed | 到期且无续费 | 正常完成周期 |
| active | paused | 用户升级 | 升级时暂停当前订阅 |
| active | cancelled | 用户主动取消 | 取消自动续费 |
| paused | active | 升级订阅到期回退 | 恢复原订阅权益 |
| paused | cancelled | 用户取消 | 暂停期间取消 |

---

## 四、业务场景实现方案（基于动态优先级重排）

核心设计思想：**购买时只设置时长，生效时间由重排算法动态决定。**

所有涉及订阅变更（购买、续费、升级、降级）的场景，均遵循统一的 **“创建-重排”** 模式：
1. **创建订阅**：仅确定订阅的时长、等级、类型，状态设为 `pending`（或 `active`），不硬性指定生效时间。
2. **触发重排**：调用订阅重排服务，根据优先级规则重新计算所有订阅的生效时间 (`effective_time`) 和过期时间 (`expire_time`)。

### 4.1 场景一：首次购买/续费/升级/降级（通用流程）

**触发条件**：用户支付完成，或产生回退订阅。

**处理流程**：
```
1. 订单支付完成回调
       │
       ▼
2. 创建新订阅记录
   - status: pending（待生效）
   - execution_type: future（由重排决定是否立即转active）
   - auto_renew: true/false
   - subscription_period: 购买时长（如30天）
   - membership_level: 购买等级
   - is_compensation: false（正常购买）
       │
       ▼
3. 调用订阅重排服务 (Reschedule Service)
   - 获取用户所有 active (含剩余时长) 和 pending 的会员类订阅
   - 执行优先级排序（规则见第六章）
   - 重新计算并更新数据库中所有订阅的 effective_time 和 expire_time
   - 如果排序第一的订阅与当前 active 订阅不同，触发状态切换（Active -> Paused/Completed, Pending -> Active）
       │
       ▼
4. 履约检查
   - 检查是否有订阅需要立即生效（effective_time <= 当前时间）
   - 执行履约（发放积分、变更权益）
```

**场景示例解析**：

**示例 A：多等级混合购买（插队生效）**
```
用户操作序列：
1. 购买专业会员（30天） -> 生效中
2. 购买企业会员（30天） -> 插队，立即生效，专业会员暂停
3. 购买专业会员（30天） -> 排队
4. 再次购买企业会员（30天） -> 插队，排在第1个企业会员之后

重排后的执行顺序（优先级排序结果）：
1. 企业会员（第1次买）：等级高，时间早
2. 企业会员（第2次买）：等级高，时间晚
3. 专业会员（第1次买）：等级低，时间早（含剩余时长）
4. 专业会员（第3次买）：等级低，时间晚
```

**示例 B：升级产生回退订阅**
```
当前状态：专业会员（Active，剩余10天）
操作：购买企业会员（30天）

处理逻辑：
1. 将当前专业会员标记为“被中断”，剩余10天转化为一个新的“补偿订阅”（Pending, is_compensation=true）
2. 创建新的企业会员订阅（Pending, 30天）
3. 触发重排：
   - 排序：企业会员(30天) > 专业会员(补偿, 10天)
   - 结果：企业会员立即生效，专业会员补偿排在30天后
```

### 4.2 场景二：订阅积分包（独立逻辑）

积分包属于一次性消费，**不参与**会员订阅的排期逻辑。

**处理流程**：
```
1. 创建订阅（status=completed, fulfillment_type=points）
2. 立即发放积分
3. 结束
```

---

## 五、微信/支付宝自动续费集成方案


### 5.1 微信委托代扣集成

#### 5.1.1 签约流程

```
用户    前端    后端    微信支付
 │       │      │        │
 │──开通自动续费▶│        │
 │       │──请求签约──▶│        │
 │       │      │──生成签约链接──▶│
 │       │◀─返回签约URL─│        │
 │       │──跳转签约页──────────▶│
 │       │      │        │──用户确认签约
 │       │      │◀───签约结果回调───│
 │       │      │──更新签约状态──│
 │◀──签约成功────│        │
```

#### 5.1.2 关键接口

| 接口 | 用途 | 端点 |
|------|------|------|
| 公众号纯签约 | 用户签约自动续费 | GET /papay/partner/entrustweb |
| 申请扣款 | 发起自动扣款 | POST /pay/partner/pappayapply |
| 预扣费通知 | 扣费前通知用户 | POST /v3/partner-papay/contracts/{id}/notify |
| 申请解约 | 解除签约关系 | POST /papay/deletecontract |
| 查询签约 | 查询签约状态 | POST /papay/querycontract |

#### 5.1.3 扣款流程（预扣费通知模式）

```
定时任务    后端    微信支付    用户
   │        │        │        │
   │──扫描到期订阅──▶│        │
   │        │──预扣费通知──▶│        │
   │        │        │──推送通知──▶│
   │        │        │        │（等待2天）
   │──触发扣款──▶│        │        │
   │        │──申请扣款──▶│        │
   │        │◀─扣款结果回调─│        │
   │        │──履约处理──│        │
```

**扣款时间规则**：
- 预扣费通知后第3-9天可发起扣款
- 扣款时间限制：每天 7:00-22:00（北京时间）
- 一个扣费周期内只能扣款成功一次

#### 5.1.4 回调处理

**签约/解约结果回调**：
- 验证签名防止假通知
- 实现幂等性处理（同一通知可能多次发送）
- 更新 auto_renew_contract 表状态

**扣款结果回调**：
- 重试机制：0/15/15/30/180/1800/1800/1800/1800/3600（秒）
- 验证签名和订单金额一致性
- 使用数据锁处理并发请求
- 扣款成功后触发订阅系统履约

### 5.2 支付宝周期扣款集成

#### 5.2.1 签约流程

与微信类似，支付宝提供周期扣款签约能力：
- 签约接口：alipay.user.agreement.page.sign
- 解约接口：alipay.user.agreement.unsign
- 扣款接口：alipay.trade.pay

#### 5.2.2 关键差异

| 对比项 | 微信 | 支付宝 |
|--------|------|--------|
| 预通知 | 必须提前2天 | 可选 |
| 扣款时间 | 7:00-22:00 | 无限制 |
| 签约方式 | 公众号/小程序/H5 | 支付宝APP/H5 |

---

## 六、定时任务与履约机制（优化版）

### 6.1 订阅优先级与重排机制（核心）

本系统摒弃复杂的“基准时间”计算，采用**动态重排算法**来管理所有订阅的生效顺序。

#### 6.1.1 优先级规则

当用户存在多个有效（Active/Pending）的会员类订阅时，系统按以下规则排序：

1.  **权益等级优先**：等级越高，优先级越高（企业会员 > 专业会员 > 普通会员）。
2.  **正常购买优先**：同等级下，正常付费订阅 (`is_compensation=false`) 优于 补偿/回退订阅 (`is_compensation=true`)。
3.  **创建时间优先**：同等级且同类型下，创建时间 (`created_at`) 越早，优先级越高。

#### 6.1.2 重排算法 (Reschedule Algorithm)

**算法输入**：用户ID
**算法输出**：无（直接更新数据库中的 effective_time 和 expire_time）

**伪代码逻辑**：
```python
def reschedule_user_subscriptions(user_id):
    # 1. 获取所有待排期的订阅（包括当前生效的）
    # 注意：如果当前 active 订阅还没到期，需要先把它"暂停"，计算剩余时间，作为一个临时对象参与排序
    # 或者简单粗暴点：获取所有 status in (active, pending, paused) 的会员订阅
    
    all_subs = fetch_subscriptions(user_id, types=['membership', 'membership_only'])
    
    # 2. 预处理：计算每个订阅的"剩余时长" (Remaining Period)
    # - 对于新购买的 Pending 订阅：时长 = subscription_period
    # - 对于正在进行或被暂停的 Active/Paused 订阅：时长 = expire_time - now (或 paused_at)
    # - 过滤掉时长 <= 0 的订阅（标记为 Completed）
    
    schedule_items = []
    for sub in all_subs:
        remaining = calculate_remaining_time(sub)
        if remaining > 0:
            schedule_items.append({
                'sub': sub,
                'duration': remaining,
                'level': sub.membership_level,
                'is_comp': sub.is_compensation,
                'created_at': sub.created_at
            })
            
    # 3. 执行排序 (核心规则)
    # Sort Key: (-Level, IsCompensation, CreatedAt)
    # Level: 3>2>1 (降序)
    # IsCompensation: False(0) < True(1) (升序) -> 非补偿优先
    # CreatedAt: (升序) -> 早创建优先
    
    schedule_items.sort(key=lambda x: (
        -x['level'], 
        x['is_comp'], 
        x['created_at']
    ))
    
    # 4. 重新计算时间轴并更新数据库
    current_time = datetime.now()
    
    for i, item in enumerate(schedule_items):
        sub = item['sub']
        duration = item['duration']
        
        # 计算新的起止时间
        new_effective = current_time
        new_expire = current_time + duration
        
        # 更新数据库记录
        if i == 0:
            # 第一个：立即生效
            sub.status = 'active'
            sub.execution_type = 'immediate'
        else:
            # 后续：排队等待
            sub.status = 'pending'
            sub.execution_type = 'future'
            
        sub.effective_time = new_effective
        sub.expire_time = new_expire
        
        # 推进时间轴
        current_time = new_expire
        
        save_to_db(sub)
```

### 6.2 定时任务列表

由于引入了重排机制，定时任务变得更加纯粹和简单。

| 任务名称 | 执行频率 | 功能描述 |
|----------|----------|----------|
| **订阅状态维护** | 每分钟 | 扫描所有 `active` 和 `pending` 订阅，根据时间自动切换状态 |
| 自动续费调度 | 每天 10:00 | 检查队列末尾的订阅，发起续费 |

#### 6.2.1 订阅状态维护任务

该任务合并了旧方案中的“到期检查”和“待生效激活”，逻辑如下：

1.  **处理过期**：
    *   查找所有 `status=active` AND `expire_time <= Now` 的订阅。
    *   将其更新为 `completed`。
2.  **处理激活**：
    *   查找所有 `status=pending` AND `effective_time <= Now` 的订阅。
    *   将其更新为 `active`。
    *   **触发履约**（如果需要）：例如发放当月积分（如果是分月发放模式）。

*注：由于重排算法已经保证了时间轴的连续性（Item N 的 End = Item N+1 的 Start），因此“过期”和“激活”通常会几乎同时发生，实现无缝切换。*

#### 6.2.2 自动续费任务

**逻辑变更**：
*   不再简单检查当前 Active 订阅。
*   而是检查用户**排期队列中最后一个订阅**。
*   如果最后一个订阅即将到期（例如剩余 < 3天），且用户开启了自动续费，则发起续费流程。
*   续费成功后，生成新订阅，再次触发 **重排算法**。

### 6.3 异常处理与容错

1.  **重排原子性**：重排过程必须在事务中执行，确保所有订阅的时间更新要么全成功，要么全失败。
2.  **并发控制**：对同一用户的重排操作需加分布式锁，防止多次购买并发导致排序混乱。
3.  **时间偏差**：定时任务可能有延迟，因此履约检查时应使用 `>=` 或 `<=` 判断，而不是严格相等。

---

## 七、异常处理与容错机制

### 7.1 幂等性设计

- 订阅创建：基于 order_no 去重
- 履约执行：基于 subscription_id + action_type 去重
- 支付回调：基于 payment_no 去重

### 7.2 事务一致性

- 订阅创建与履约在同一事务中执行
- 使用乐观锁防止并发更新冲突
- 履约失败时记录日志，支持人工介入

### 7.3 自动续费失败处理

```
扣款失败
   │
   ├─余额不足 → 发送通知提醒用户充值 → 次日重试（最多3次）
   │
   ├─签约已解除 → 标记订阅为非自动续费
   │
   └─其他错误 → 记录日志 → 人工介入
```

---

## 八、关键文件路径（现有代码）

| 模块 | 文件路径 |
|------|----------|
| 用户模型 | backend/passport/app/models/user.py |
| 会员套餐 | backend/membership/models/membership.py |
| 会员API | backend/membership/api/membership.py |
| 积分模型 | backend/points/models/points.py |
| 积分服务 | backend/points/services/points_service.py |
| 订单模型 | backend/order/models/order.py |
| 支付API | backend/payment/api/payment.py |

---

## 九、总结

本技术方案设计了一个完整的SaaS月度会员订阅状态机管理系统，核心特点：

1. **清晰的系统边界**：订单系统负责交易，订阅系统负责履约
2. **完善的状态机**：5种状态覆盖所有业务场景
3. **灵活的履约类型**：支持会员、积分、仅权益三种履约方式
4. **升级回退机制**：通过父子订阅关联实现权益回退
5. **自动续费集成**：支持微信/支付宝委托代扣
6. **健壮的容错机制**：幂等性、事务一致性、失败重试

