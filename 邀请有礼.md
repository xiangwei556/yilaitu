"邀请有礼"功能完整产品技术方案 V3.0（无优惠券版）
一、产品概述
1.1 核心目标
拉新增长：通过社交裂变获取新用户

转化促进：激励新用户完成首充关键行为

用户留存：通过奖励机制提升邀请人和被邀请人粘性

1.2 业务流程图
sequenceDiagram
    participant 邀请人
    participant App
    participant 邀请服务
    participant 用户服务
    participant 风控服务
    participant 积分服务
    participant 支付服务
    participant 账户服务

    邀请人->>App: 进入邀请页面
    App->>邀请服务: 获取邀请码/链接
    邀请服务-->>App: 返回邀请信息
    邀请人->>被邀请人: 分享邀请链接
    
    被邀请人->>App: 通过链接注册
    用户服务->>邀请服务: 注册成功，绑定邀请关系
    邀请服务->>风控服务: 反作弊校验
    风控服务-->>邀请服务: 校验通过
    邀请服务->>积分服务: 发放注册积分
    
    被邀请人->>App: 首次充值
    支付服务->>邀请服务: 通知首充完成
    邀请服务->>风控服务: 二次风控校验
    邀请服务->>账户服务: 发放现金返利
    邀请服务->>积分服务: 发放首充积分
二、系统架构设计
2.1 服务依赖关系











2.2 服务职责
邀请服务：核心业务流程控制，规则引擎，奖励分发

风控服务：邀请行为反作弊，风险识别

积分服务：已有服务，积分发放与扣减

账户服务：用户余额管理，资金入账

支付服务：支付订单处理，首充判断

三、数据模型设计
3.1 核心表结构
sql
-- 邀请活动配置表
CREATE TABLE `invite_activity_config` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(50) NOT NULL COMMENT '活动名称',
  `status` TINYINT DEFAULT 1 COMMENT '1启用 0禁用',
  `register_points` INT DEFAULT 0 COMMENT '注册奖励积分',
  `recharge_cash_ratio` DECIMAL(5,3) DEFAULT 0.15 COMMENT '首充现金返现比例',
  `recharge_points` INT DEFAULT 0 COMMENT '首充奖励积分',
  `start_time` DATETIME,
  `end_time` DATETIME,
  `anti_cheat_rules` JSON COMMENT '风控规则',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 邀请关系表
CREATE TABLE `invite_relation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `inviter_id` BIGINT NOT NULL COMMENT '邀请人ID',
  `invitee_id` BIGINT NOT NULL COMMENT '被邀请人ID',
  `invite_code` VARCHAR(20) NOT NULL COMMENT '邀请码',
  `channel` VARCHAR(20) DEFAULT 'link' COMMENT '邀请渠道',
  `device_id` VARCHAR(64) COMMENT '设备ID',
  `ip` VARCHAR(45) COMMENT 'IP地址',
  `relation_status` TINYINT DEFAULT 0 COMMENT '0正常 1无效 2作弊',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_invitee` (`invitee_id`),
  KEY `idx_inviter` (`inviter_id`, `created_at`),
  KEY `idx_code` (`invite_code`)
);

-- 奖励发放记录表
CREATE TABLE `invite_reward_log` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `relation_id` BIGINT NOT NULL COMMENT '邀请关系ID',
  `reward_type` VARCHAR(20) NOT NULL COMMENT 'cash/points',
  `reward_amount` DECIMAL(12,2) NOT NULL,
  `status` TINYINT DEFAULT 0 COMMENT '0待发放 1成功 2失败 3冻结',
  `biz_id` VARCHAR(64) NOT NULL COMMENT '业务唯一ID，用于幂等',
  `target_service` VARCHAR(30) COMMENT '目标服务：points/account',
  `service_response` JSON COMMENT '服务响应数据',
  `trigger_event` VARCHAR(30) NOT NULL COMMENT '触发事件',
  `trigger_user_id` BIGINT NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `finished_at` DATETIME,
  UNIQUE KEY `uk_biz_id` (`biz_id`),
  KEY `idx_relation` (`relation_id`, `trigger_event`),
  KEY `idx_status` (`status`, `created_at`)
);
3.2 缓存设计
yaml
# Redis Key设计
invite:code:{code} -> inviter_id (有效期7天)
invite:dashboard:{user_id} -> 用户面板数据 (有效期5分钟)
invite:limit:ip:{ip} -> 当日邀请次数 (防刷)
invite:reward_lock:{biz_id} -> 1 (分布式锁，防重发)
四、核心接口设计
4.1 对客接口
接口	方法	描述	认证
/api/v1/invite/info	GET	获取用户邀请信息（链接、二维码、数据）	用户Token
/api/v1/invite/records	GET	邀请记录分页查询	用户Token
/api/v1/invite/rewards	GET	奖励记录查询	用户Token
/api/v1/invite/cash/claim	POST	领取现金奖励	用户Token
4.2 内部服务接口
接口	调用方	功能	幂等
POST /internal/invite/bind	用户服务	注册后绑定邀请关系	是
POST /internal/invite/trigger/recharge	支付服务	首充奖励触发	是
GET /internal/invite/check	风控服务	邀请关系校验	-
4.3 积分服务接口（已有）
接口	功能	幂等控制
POST /internal/points/grant	发放积分	biz_id唯一
POST /internal/points/deduct	扣减积分	biz_id唯一
五、奖励发放流程
5.1 注册奖励发放流程
text
1. 用户服务注册成功 → 调用 invite/bind
2. 邀请服务验证邀请码有效性
3. 调用风控服务进行基础校验
4. 保存邀请关系
5. 查询活动配置中的 register_points
6. 如果 register_points > 0：
   - 生成唯一 biz_id = "invite_reg_{relation_id}_points_{timestamp}"
   - 检查幂等（查询 reward_log）
   - 调用积分服务发放积分（传递 biz_id）
   - 记录发放日志
7. 返回绑定成功
5.2 首充奖励发放流程
text
1. 支付服务首充成功 → 调用 invite/trigger/recharge
2. 邀请服务查询 invitee_id 对应的有效邀请关系
3. 调用风控服务进行二次校验（防套利）
4. 处理现金奖励：
   - 生成 cash_biz_id = "invite_recharge_{order_no}_cash"
   - 检查幂等
   - 计算返现金额 = 充值金额 × 返现比例
   - 调用账户服务入账
5. 处理积分奖励：
   - 生成 points_biz_id = "invite_recharge_{order_no}_points"
   - 检查幂等
   - 调用积分服务发放固定积分或按比例积分
6. 异步更新邀请人数据面板缓存
5.3 积分发放实现细节
java
// 邀请服务调用积分服务的示例
public class PointsServiceClient {
    
    @Resource
    private RestTemplate restTemplate;
    
    public boolean grantPoints(Long userId, Integer points, String bizId, String source) {
        try {
            PointsGrantRequest request = PointsGrantRequest.builder()
                .userId(userId)
                .points(points)
                .bizType("invite_reward")
                .bizId(bizId)  // 关键：幂等控制
                .source(source)
                .validDays(365)
                .remark("邀请活动奖励")
                .build();
                
            // 调用已有积分服务
            Response<PointsGrantResponse> response = restTemplate.postForObject(
                "http://points-service/internal/points/grant",
                request,
                Response.class
            );
            
            return response != null && response.isSuccess();
        } catch (Exception e) {
            log.error("调用积分服务失败: userId={}, bizId={}", userId, bizId, e);
            // 记录失败，定时任务重试
            return false;
        }
    }
}
六、风控与防作弊策略
6.1 多层风控规则
层级	规则	处理方式
基础规则	同IP邀请超过10个/天	拦截绑定
同设备邀请超过5个/天	拦截绑定
邀请自己（同账号）	拒绝
行为规则	注册到首充时间＜1分钟	奖励冻结审核
被邀请人无活跃行为	延迟发放
业务规则	邀请人历史作弊记录	禁止参与
黑名单设备/IP	拒绝所有邀请
6.2 奖励安全机制
审核期机制：大额奖励设置24小时审核期

延迟发放：可疑行为延迟1-3天发放

额度限制：单日单人奖励上限控制

提现限制：奖励资金需交易后才可提现

七、部署与运维方案
7.1 环境配置
yaml
# application-invite.yml
invite:
  activity:
    enabled: true
    default-code-length: 8
  reward:
    async-enabled: true
    retry-times: 3
    mq-topic: invite-reward-topic
  risk:
    check-enabled: true
    auto-block-threshold: 0.8
  points:
    service-url: http://points-service:8080
    timeout-ms: 3000
7.2 监控指标
指标	报警阈值	监控方式
邀请绑定成功率	<95%	Prometheus + Grafana
奖励发放失败率	>5%	ELK日志监控
积分服务调用延迟	>1000ms	SkyWalking
作弊拦截率	异常波动	数据对比
资金发放对账差异	>0.01元	每日对账任务
7.3 数据库优化
sql
-- 关键索引
CREATE INDEX idx_invite_composite ON invite_relation(inviter_id, relation_status, created_at);
CREATE INDEX idx_reward_status ON invite_reward_log(status, created_at);
CREATE INDEX idx_invitee_event ON invite_reward_log(trigger_user_id, trigger_event);

-- 分区建议（按时间）
ALTER TABLE invite_reward_log PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026)
);
八、数据统计与报表
8.1 核心数据看板
sql
-- 邀请漏斗分析
SELECT 
    DATE(ir.created_at) as date,
    COUNT(DISTINCT ir.inviter_id) as active_inviters,
    COUNT(DISTINCT ir.id) as total_invites,
    COUNT(DISTINCT CASE WHEN ir.relation_status = 0 THEN ir.invitee_id END) as success_invites,
    COUNT(DISTINCT CASE WHEN rl.trigger_event = 'FIRST_RECHARGE' THEN rl.trigger_user_id END) as recharge_conversions,
    ROUND(COUNT(DISTINCT CASE WHEN rl.trigger_event = 'FIRST_RECHARGE' THEN rl.trigger_user_id END) * 100.0 / COUNT(DISTINCT ir.id), 2) as conversion_rate
FROM invite_relation ir
LEFT JOIN invite_reward_log rl ON ir.id = rl.relation_id
WHERE ir.created_at >= CURDATE() - INTERVAL 7 DAY
GROUP BY DATE(ir.created_at);
8.2 对账任务设计
java
@Component
public class InviteRewardReconciliationJob {
    
    // 每日凌晨2点执行
    @Scheduled(cron = "0 0 2 * * ?")
    public void dailyReconciliation() {
        // 1. 核对奖励发放状态一致性
        // 2. 比对积分服务发放记录
        // 3. 资金账户余额核对
        // 4. 生成对账差异报告
    }
}
九、上线与回滚方案
9.1 灰度发布策略
阶段	用户比例	验证重点
内部测试	员工100%	全流程验证
小流量	用户1%	积分服务调用
中流量	用户10%	风控规则有效性
全量	用户100%	性能与稳定性
9.2 回滚检查点
配置回滚：活动配置可快速关闭

代码回滚：服务支持版本快速回退

数据补偿：准备奖励撤回脚本

客户沟通：准备公告模板

方案总结
本方案实现了：

简洁设计：仅保留积分和现金两种奖励，逻辑清晰

积分服务集成：通过标准接口调用，支持幂等控制

完整风控体系：多层防御机制，保障资金安全

可扩展架构：奖励规则配置化，易于扩展

运维保障：完善的监控、对账、灰度发布机制

关键成功因素：

与已有积分服务的稳定对接

风控规则的准确性和及时性

奖励发放的最终一致性保证

实时数据监控和快速响应能力

此方案可在2个迭代周期内完成开发上线，建议分阶段实施，优先保证核心流程和风控机制。