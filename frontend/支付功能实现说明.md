# 会员支付功能实现说明

## 一、实现功能

### ✅ 已完成功能

1. **创建支付订单**
   - 用户选择会员套餐时，自动调用后端API创建订单
   - 支持会员套餐和积分包购买
   - 订单创建成功后自动生成支付二维码

2. **支付二维码展示**
   - 在页面右侧区域显示支付二维码
   - 使用 `qrcode` 库生成二维码图片
   - 显示订单详情（商品名称、金额）

3. **订单状态轮询**
   - 创建订单后自动开始轮询订单状态（每3秒查询一次）
   - 支付成功后自动更新UI并关闭弹窗
   - 30秒后自动停止轮询（订单过期时间）

4. **微信支付支持**
   - 目前只实现微信支付
   - 支付宝支付后续开发（UI已预留）

### 📁 修改的文件

1. **新增文件**：
   - `frontend/src/api/payment.ts` - 支付API接口文件

2. **修改文件**：
   - `frontend/src/pages/components/MembershipModal.tsx` - 会员选择弹窗组件

## 二、功能流程

### 1. 用户选择套餐流程
```
用户打开会员弹窗
  ↓
加载套餐列表（会员套餐/积分包）
  ↓
用户点击选择套餐
  ↓
自动调用创建订单API（POST /api/v1/payment/create-order）
  ↓
后端返回订单信息和支付二维码URL
  ↓
前端生成二维码图片并显示在右侧
  ↓
开始轮询订单状态（每3秒查询一次）
```

### 2. 支付成功流程
```
用户扫码支付
  ↓
支付平台回调后端
  ↓
后端更新订单状态为"paid"
  ↓
前端轮询检测到订单状态为"paid"
  ↓
显示支付成功提示
  ↓
1.5秒后自动关闭弹窗
  ↓
刷新页面（刷新用户信息）
```

## 三、技术实现细节

### 3.1 API接口调用

```typescript
// 创建支付订单
const orderData = await createPaymentOrder({
  product_type: 'membership' | 'points',
  product_id: packageId,
  payment_method: 'wechat',
  is_upgrade: false
});

// 返回数据结构
{
  order_no: string,
  amount: number,
  qr_code_url: string,
  qr_code_expire_at: string,
  expire_at: string
}
```

### 3.2 二维码生成

```typescript
import QRCode from 'qrcode';

// 生成二维码图片
const qrCodeUrl = await QRCode.toDataURL(orderData.qr_code_url, {
  width: 200,
  margin: 2,
  color: {
    dark: '#000000',
    light: '#FFFFFF'
  }
});
```

### 3.3 订单状态轮询

```typescript
// 每3秒查询一次订单状态
const pollInterval = setInterval(async () => {
  const statusData = await getOrderStatus(orderNo);
  if (statusData.status === 'paid') {
    // 支付成功，停止轮询并刷新页面
    clearInterval(pollInterval);
    // ... 处理支付成功逻辑
  }
}, 3000);

// 30秒后自动停止轮询
setTimeout(() => {
  clearInterval(pollInterval);
}, 30000);
```

## 四、UI展示

### 4.1 订单详情区域（右侧）

- **商品名称**：显示选择的套餐名称
- **应付金额**：显示套餐价格
- **支付方式**：目前只显示微信支付（支付宝按钮已禁用，显示"开发中"）
- **支付二维码**：
  - 未选择套餐：显示提示"选择套餐后将自动生成支付二维码"
  - 创建订单中：显示加载动画
  - 订单创建成功：显示支付二维码
  - 支付成功：显示成功提示

### 4.2 状态提示

- **创建订单中**：显示"正在创建订单..."加载提示
- **订单创建成功**：显示"订单创建成功，请扫码支付"
- **支付成功**：显示"✓ 支付成功"，1.5秒后关闭弹窗并刷新页面

## 五、注意事项

### 5.1 订单创建时机

- **首次选择套餐**：自动创建订单
- **切换套餐**：如果选择不同的套餐，会重置订单并创建新订单
- **重复选择同一套餐**：如果已有订单，不会重复创建

### 5.2 轮询机制

- 订单创建成功后自动开始轮询
- 每3秒查询一次订单状态
- 支付成功或订单取消时停止轮询
- 30秒后自动停止轮询（订单过期时间）

### 5.3 错误处理

- **创建订单失败**：显示错误提示，不显示二维码
- **生成二维码失败**：显示错误提示
- **轮询查询失败**：不中断轮询，继续尝试

### 5.4 支付方式

- **微信支付**：✅ 已实现
- **支付宝支付**：⏳ 后续开发（UI已预留）

## 六、测试建议

### 6.1 功能测试

1. **选择会员套餐**
   - 打开会员弹窗
   - 点击选择不同的会员套餐
   - 验证右侧是否显示订单详情和二维码

2. **创建订单**
   - 选择套餐后，验证是否正确调用API
   - 验证返回的订单信息是否正确
   - 验证二维码是否正确生成和显示

3. **支付流程**
   - 使用微信扫码支付
   - 验证订单状态是否正确更新
   - 验证支付成功后是否正确关闭弹窗

4. **切换套餐**
   - 选择套餐A，验证创建订单A
   - 切换选择套餐B，验证创建订单B（订单A应被重置）

5. **轮询机制**
   - 创建订单后，验证是否开始轮询
   - 等待30秒，验证是否自动停止轮询
   - 支付成功后，验证是否立即停止轮询

### 6.2 错误场景测试

1. **网络错误**
   - 断开网络，验证错误提示是否正常显示

2. **订单创建失败**
   - 模拟后端返回错误，验证错误提示是否正常显示

3. **二维码生成失败**
   - 模拟无效的二维码URL，验证错误处理是否正常

## 七、后续优化建议

1. **WebSocket实时通知**
   - 如果已建立WebSocket连接，可以使用WebSocket接收支付成功通知
   - 减少轮询次数，提高实时性

2. **支付超时处理**
   - 显示订单倒计时
   - 订单过期时自动刷新订单状态

3. **支付失败处理**
   - 显示支付失败原因
   - 提供重新支付按钮

4. **订单详情页面**
   - 点击订单号可以查看订单详情
   - 显示支付进度

5. **支付宝支付**
   - 实现支付宝支付接口
   - 支持支付宝扫码支付

## 八、相关API接口

### 创建支付订单
```
POST /api/v1/payment/create-order
Authorization: Bearer {token}

Request Body:
{
    "product_type": "membership",
    "product_id": 1,
    "payment_method": "wechat",
    "is_upgrade": false
}

Response:
{
    "order_no": "ORD202501011200001",
    "amount": 99.00,
    "qr_code_url": "weixin://wxpay/bizpayurl?pr=xxx",
    "qr_code_expire_at": "2025-01-01T12:15:00",
    "expire_at": "2025-01-01T12:30:00"
}
```

### 查询订单状态
```
GET /api/v1/payment/order-status?order_no=ORD202501011200001
Authorization: Bearer {token}

Response:
{
    "order_no": "ORD202501011200001",
    "status": "paid",
    "amount": 99.00,
    "payment_time": "2025-01-01T12:05:00"
}
```

## 九、代码结构

```
frontend/src/
├── api/
│   └── payment.ts                    # 支付API接口
├── pages/
│   └── components/
│       └── MembershipModal.tsx       # 会员选择弹窗（已修改）
└── utils/
    └── request.js                    # HTTP请求工具（已有）
```

## 十、使用说明

1. **打开会员弹窗**
   - 点击页面上的"开通会员"按钮

2. **选择套餐**
   - 在左侧选择要购买的会员套餐或积分包
   - 选择后会自动在右侧显示订单详情和支付二维码

3. **扫码支付**
   - 使用微信扫码右侧的支付二维码
   - 完成支付

4. **等待支付结果**
   - 支付成功后会自动关闭弹窗并刷新页面
   - 如果30秒内未支付，订单会自动过期
